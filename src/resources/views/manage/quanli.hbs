<table class="table">
    <tbody>
        {{!-- Sử dụng helper 'range' để tạo các hàng tầng một cách động --}}
        {{#each (range 2 5)}} {{!-- Thay đổi số 2 và 5 tùy theo số tầng bạn muốn hiển thị --}}
        <tr>
            <td class="floor">Tầng {{this}}</td>
            {{#each ../Rooms}} {{!-- Dùng ../Rooms để truy cập biến Rooms từ scope cha --}}
                {{#if (eq this.floor (toString ../this))}} {{!-- So sánh tầng của phòng với tầng hiện tại --}}
                    <td class="table__room
                        {{#if (eq this.displayStatus 'Đang ở')}} checked-in {{!-- Phòng đang có khách (check-in) --}}
                        {{else if (eq this.displayStatus 'Đã đặt')}} booked {{!-- Phòng đã đặt cho hôm nay (chưa check-in) --}}
                        {{else if (eq this.displayStatus 'Dọn dẹp')}} cleaning {{!-- Phòng đang chờ dọn dẹp --}}
                        {{else}} available {{!-- Phòng trống --}}
                        {{/if}}"
                        style="position: relative;"
                        data-room-id="{{this._id}}"> {{!-- Thêm data-room-id để JS dễ truy cập --}}

                        <h2 class="table__room__heading">{{this.roomNumber}}</h2>

                        {{!-- Hiển thị thông tin booking nếu có booking CHO HÔM NAY --}}
                        {{#if this.booking}}
                            <p>{{this.roomType.name}}</p>
                            <p><i class="fa-regular fa-user"></i> {{this.booking.customer.fullName}}</p>
                            <p><i class="fa-light fa-phone"></i> {{this.booking.customer.phone}} </p>
                            {{!-- Có thể thêm ngày check-in/out của booking hiện tại nếu muốn --}}
                            {{!-- <p>Từ: {{Date this.booking.checkInDate}}</p>
                            <p>Đến: {{Date this.booking.checkOutDate}}</p> --}}

                        {{else if (eq this.displayStatus 'Dọn dẹp')}}
                            <p>{{this.roomType.name}}</p>
                            <p>Đang chờ dọn</p> 
                        {{else}}
                            <p>{{this.roomType.name}}</p>
                            <p>Giá: {{money this.price}} VNĐ</p> {{!-- Sử dụng this.price đã tính toán ở Controller --}}
                            <p>{{this.bedType.name}}</p>
                        {{/if}}

                        {{!-- Nút Đánh dấu sạch (Chỉ hiện khi phòng có trạng thái 'Dọn dẹp') --}}
                        {{#if (eq this.displayStatus 'Dọn dẹp')}}
                            <button class="btn btn-sm btn-warning js-mark-clean-btn"
                                    data-room-id="{{this._id}}"
                                    style="position: absolute; bottom: 5px; left: 5px; color: #fff; background-color: #ffc107; border-color: #ffc107;">
                                <i class="fa-solid fa-broom"></i> Sạch
                            </button>
                        {{/if}}

                        {{!-- Nút Đặt phòng thủ công (Chỉ hiện khi phòng 'Trống') --}}
                        {{#if (eq this.displayStatus 'Trống')}}
                            <button class="btn btn-sm btn-light js-manual-book-btn"
                                    data-room-id="{{this._id}}"
                                    data-room-number="{{this.roomNumber}}"
                                    style="position: absolute; bottom: 5px; right: 5px;">
                                <i class="fa-solid fa-plus"></i> Đặt
                            </button>
                        {{/if}}
                    </td>
                {{/if}}
            {{/each}}
        </tr>
        {{/each}}
    </tbody>
</table>

{{!-- Modal Đặt phòng thủ công (chỉ hiện khi click nút Đặt) --}}
<div class="modal__booking js-admin-modal-booking" id="adminBookingModalContainer"> 
    <div class="modal__booking__container"> 
        <div class="modal__booking__close js-admin-modal-close"> 
            <i class="fa-solid fa-xmark"></i>
        </div>
        <div class="modal__booking__header">
            Tạo Phiếu Thuê Mới - Phòng&nbsp;<span id="modalRoomNumberAdmin"> </span> 
        </div>
        
        <form id="adminBookingFormManual"> 
            <input type="hidden" id="modalRoomIdAdmin" name="roomId"> 

            <div style="padding: 0 20px; max-height: 400px; overflow-y: auto;"> 
                <div class="row modal__booking__contet">
                    {{!-- Cột trái: Thông tin đặt phòng --}}
                    <div class="col-6">
                        <div class="modal__booking__title">Thông tin đặt phòng</div>
                        <div class="modal__booking__body">
                            <label class="modal__booking__label" for="checkInDateAdminManual">Nhận phòng *</label> 
                            <input type="date" class="modal__booking__input" id="checkInDateAdminManual" name="checkInDate" required>
                        </div>
                        <div class="modal__booking__body">
                            <label class="modal__booking__label" for="checkOutDateAdminManual">Trả phòng *</label> 
                            <input type="date" class="modal__booking__input" id="checkOutDateAdminManual" name="checkOutDate" required>
                        </div>
                    </div>

                    {{!-- Cột phải: Thông tin khách hàng --}}
                    <div class="col-6">
                        <div class="modal__booking__title">Thông tin khách hàng</div>
                        <div class="modal__booking__body">
                            <label class="modal__booking__label" for="fullNameAdminManual">Họ và Tên *</label> 
                            <input type="text" class="modal__booking__input" id="fullNameAdminManual" name="fullName" required>
                        </div>
                        <div class="modal__booking__body">
                            <label class="modal__booking__label" for="phoneAdminManual">Số điện thoại *</label> 
                            <input type="tel" class="modal__booking__input" id="phoneAdminManual" name="phone" required>
                        </div>
                        <div class="modal__booking__body">
                            <label class="modal__booking__label" for="emailAdminManual">Email</label> 
                            <input type="email" class="modal__booking__input" id="emailAdminManual" name="email">
                        </div>
                    </div>
                </div>

                {{!-- Phần chọn dịch vụ (Tùy chọn) --}}
                {{#if allServices}}
                <a class="btn modal__booking__chooseService mt-3" data-toggle="collapse" href="#serviceCollapseAdmin" role="button" aria-expanded="false" aria-controls="serviceCollapseAdmin">
                    Chọn dịch vụ
                </a>
                <div class="collapse mt-2 modal__booking__service" id="serviceCollapseAdmin" style="margin-left: 0; width: 100%;">
                    {{#each allServices}}
                        <div class="modal__booking__service__form" >
                            <label class="modal__booking__service__lable" style="min-width: 150px;">{{this.name}}:</label>
                            <div class="modal__booking__service__form1">
                                <input type="number" name="{{this._id}}" min="0" value="0"
                                        class="form-control modal__booking__service__input service-input-admin" 
                                        data-price="{{this.price}}" data-id="{{this._id}}">
                                <span class="modal__booking__service__price ">{{money this.price}} VNĐ/&nbsp;</span>
                                <span style="font-size: 1.4rem;"> {{this.unit}}</span>
                            </div>
                        </div>
                    {{/each}}
                </div>
                {{/if}}
            </div> 

            {{!-- Footer với nút bấm --}}
            <div class="modal__booking__frame__btn">
                <button type="submit" class="btn modal__booking__btn">Lưu Phiếu Thuê</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Modal Đặt phòng Thủ công ---
    const adminModalContainer = document.getElementById('adminBookingModalContainer');
    const adminModalCloseBtn = adminModalContainer.querySelector('.js-admin-modal-close');
    const adminBookingForm = document.getElementById('adminBookingFormManual');

    // Mở Modal
    document.querySelectorAll('.js-manual-book-btn').forEach(button => {
        button.addEventListener('click', function() {
            const roomId = this.dataset.roomId;
            const roomNumber = this.dataset.roomNumber;

            // Điền thông tin vào modal
            adminModalContainer.querySelector('#modalRoomIdAdmin').value = roomId;
            adminModalContainer.querySelector('#modalRoomNumberAdmin').textContent = roomNumber;

            // Đặt ngày mặc định cho check-in/check-out là hôm nay và ngày mai
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const formatDate = (date) => {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months start at 0!
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            };

            adminModalContainer.querySelector('#checkInDateAdminManual').value = formatDate(today);
            adminModalContainer.querySelector('#checkOutDateAdminManual').value = formatDate(tomorrow);

            // Reset form
            adminBookingForm.reset();
            // Reset dịch vụ (nếu có)
            adminModalContainer.querySelectorAll('.service-input-admin').forEach(input => input.value = 0);

            // Hiện modal
            adminModalContainer.style.display = 'flex';
            document.body.classList.add('no-scroll');
        });
    });

    // Đóng Modal
    adminModalCloseBtn.addEventListener('click', function() {
        adminModalContainer.style.display = 'none';
        document.body.classList.remove('no-scroll');
    });
    // Đóng khi click bên ngoài (tùy chọn)
    adminModalContainer.addEventListener('click', function(event) {
        if (event.target === adminModalContainer) {
            adminModalContainer.style.display = 'none';
            document.body.classList.remove('no-scroll');
        }
    });

    // Submit Form Modal
    adminBookingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(adminBookingForm);

        // Chuyển FormData thành JSON object
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        // Xử lý dịch vụ (Nếu có)
        const services = [];
        adminModalContainer.querySelectorAll('.service-input-admin').forEach(input => {
            const quantity = parseInt(input.value, 10) || 0;
            if (quantity > 0) {
                services.push({
                    id: input.dataset.id,
                    quantity: quantity,
                    price: parseInt(input.dataset.price, 10) || 0
                });
            }
        });
        data.services = services;

        // Đánh dấu là booking thủ công
        data.source = 'manual';

        try {
            const response = await fetch('/datphong', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.message === 'success') {
                alert('Tạo phiếu thuê thành công!');
                adminModalContainer.style.display = 'none'; // Đóng modal
                document.body.classList.remove('no-scroll');
                window.location.reload(); // Tải lại trang
            } else {
                // Hiển thị lỗi chi tiết hơn từ server
                alert('Lỗi: ' + (result.message || 'Không thể tạo phiếu thuê.'));
            }
        } catch (error) {
            console.error('Lỗi khi gửi yêu cầu đặt phòng:', error);
            alert('Đã có lỗi xảy ra phía client.');
        }
    });

    // Nút "Đánh dấu sạch"
    document.querySelectorAll('.js-mark-clean-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const roomId = this.dataset.roomId; 
            const roomNumberElement = this.closest('.table__room').querySelector('.table__room__heading');
            const roomNumber = roomNumberElement ? roomNumberElement.textContent.trim() : 'này'; // Lấy số phòng

            if (!confirm(`Xác nhận phòng [${roomNumber}] đã được dọn sạch?`)) {
                return; 
            }

            try {
                const response = await fetch(`/manage/quan_li_phong/crud/${roomId}/clean`, {
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Đã cập nhật trạng thái phòng thành Trống!');
                    window.location.reload(); 
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể cập nhật trạng thái.'));
                }
            } catch (error) {
                console.error('Lỗi khi gọi API mark-clean:', error);
                alert('Đã có lỗi xảy ra phía client khi cập nhật trạng thái.');
            }
        });
    });
});
</script>