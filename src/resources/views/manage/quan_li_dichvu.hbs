  <div class="row manage_body">
    <div class="col-2" style="padding-right: 0;margin-top: 117px">
        <form class="form__sreach " method="GET" action="/manage/quan_li_dichvu">
          <p class="lable__search">Tìm kiếm</p>
          <select class="form-control mt-2" name="khoangGia" id="">
            <option value="Tất cả giá">Tất cả giá trị </option>
            <option value="lt200">Dưới 100.000</option>
            <option value="200to400">Từ 100.000 - 200.000</option>
            <option value="gt400">Trên 200.000</option>
          </select>
          <button class="btn btn-primary  form__sreach__btn">Lọc thông tin</button>   
        </form>
    </div>
    <div class="col-10">
        <div class="form_quanliphong" >

            <h2>Danh sách Dịch vụ</h2>
            
            <div style="display: flex; justify-content: end;" ><a class="btn form_quanliphong__btn__them" href="/manage/quan_li_dichvu/crud/show_create">Thêm dịch vụ</a></div>
            {{#if query.success}}
                <div class="alert alert-success auto-dismiss-alert"> 
                    {{#if (eq query.success 'activated')}}Dịch vụ đã được mở lại.{{/if}}
                    {{#if (eq query.success 'deactivated')}}Dịch vụ đã được tạm ngưng.{{/if}}
                    {{#if (eq query.success 'serviceDeleted')}}Đã xóa dịch vụ thành công.{{/if}}
                    {{!-- Các thông báo thành công khác --}}
                </div>
            {{/if}}

            {{!-- Hiển thị thông báo lỗi --}}
            {{#if query.error}}
                <div class="alert alert-danger auto-dismiss-alert"> 
                    {{#if (eq query.error 'serviceInUse')}}
                        <strong>Không thể xóa!</strong> Dịch vụ này đang được sử dụng bởi ít nhất một phiếu thuê đang hoạt động. Vui lòng kiểm tra lại.
                    {{else}}
                        Đã có lỗi không xác định xảy ra.
                    {{/if}}
                </div>
            {{/if}}
            <table class="table mt-4">
                <thead>
                    <tr> 
                        <th scope="col">STT</th>
                        <th scope="col">Mã dịch vụ</th>
                        <th scope="col">Dịch vụ</th>
                        <th class="haha" scope="col">Giá</th>        
                        <th class="haha" scope="col">Đơn vị</th> 
                        <th scope="col">Trạng thái</th> {{!-- Thêm cột trạng thái --}}
                        <th scope="col" colspan="2" style="text-align: center;">Thao tác</th>       
                        <th scope="col" colspan="2"></th>         
                    </tr>
                </thead>
                <tbody>
                    {{#each Services}}
                    <tr>
                    
                        <th scope="row">{{sum @index 1}}</th>
                        <td>{{this.idService}}</td>
                        <td>{{this.name}}</td>
                        <td>{{this.price}}</td>
                        <td>{{this.unit}}</td>
                        <td>
                             {{#if this.isActive}}
                                <span class="badge badge-success">Đang hoạt động</span>
                            {{else}}
                                <span class="badge badge-secondary">Tạm ngưng</span>
                            {{/if}}
                        </td>
                        <td>
                             {{!-- Form để Tạm ngưng / Mở lại --}}
                            <form action="/manage/quan_li_dichvu/crud/{{this._id}}/toggle-status?_method=PUT" method="POST" onsubmit="return confirm('Bạn có chắc muốn {{#if this.isActive}}tạm ngưng{{else}}mở lại{{/if}} dịch vụ {{this.name}} không?');">
                                 {{#if this.isActive}}
                                    <button type="submit" class="btn btn-sm btn-primary">Tạm ngưng</button>
                                {{else}}
                                     <button type="submit" class="btn btn-sm btn-success">Mở lại</button>
                                {{/if}}
                            </form>
                        </td>
                        <td><a href="/manage/quan_li_dichvu/crud/{{this._id}}/show_update" class="btn btn-sm btn-primary" style="font-size: 1.4rem;">Sửa</a></td> 
                        <td><a href="#" class="btn btn-danger"  data-toggle="modal" data-id="{{this._id}}" data-target="#exampleModal">Xóa</a></td>              
                    </tr>

                    {{else}}
                    <tr>
                        <td colspan="5" class="text-center">
                        Bạn chưa có phòng nào.
                        <a href="/manage/quan_li_phong/create" >Thêm Dịch vụ</a>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div> 
    </div>
</div>  


  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Xóa Phòng</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
              <h5 class="modal-title" id="exampleModalLabel">Bạn xác nhận muốn xóa chứ ?</h5>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
          <button id="btn-id-delete" type="button" class="btn btn-danger" >Xóa</button>       
        </div>
      </div>
    </div>
  </div>



<form name="delete-service-form" method="POST"></form>
{{#if success}}
  <div id="success-alert" class="Tb_thanhcong">
    Cập nhật dịch vụ thành công!
  </div>
{{/if}}

<script>
  setTimeout(() => {
    const alert = document.getElementById('success-alert');
    if (alert) alert.remove();
  }, 1000);
</script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        var serviceId; 
        var deleteForm = document.forms['delete-service-form']; 
        var btnDeleteService = document.getElementById('btn-id-delete');

        $('#exampleModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            serviceId = button.data('id'); // Lấy ID dịch vụ
        });

        // Khi nhấn nút "Xóa bỏ" trong modal
        btnDeleteService.onclick = function(){
            // Đặt action cho form ẩn, trỏ đến đúng route DELETE
            deleteForm.action = '/manage/quan_li_dichvu/crud/' + serviceId + '/delete?_method=DELETE';
            deleteForm.submit(); // Submit form ẩn
        }


    });
</script>

<script>
    // Tự động ẩn thông báo sau 3 giây (3000ms)
    setTimeout(() => {
        const alerts = document.querySelectorAll('.auto-dismiss-alert'); // Tìm tất cả alert cần ẩn
        alerts.forEach(alert => {
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease'; // Thêm hiệu ứng mờ dần (tùy chọn)
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500); // Xóa hẳn sau khi mờ
            }
        });
    }, 3000); // Thời gian hiển thị (3000ms = 3 giây)
</script>

