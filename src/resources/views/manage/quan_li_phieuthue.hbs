  <div class="row manage_body">
    <div class="col-12 ">
      <div class="form_quanliphong">
         <div class="d-flex justify-content-between align-items-start mb-4"> {{!-- Flexbox: space-between --}}
                {{!-- Tiêu đề bên trái --}}
                <h2 style="margin-bottom: 0;">Danh sách phiếu thuê</h2>

                <fsorm class="form__sreach ql_phieuthue" method="GET" action="/manage/quan_li_phieuthue"> {{!-- Bỏ margin-top, set width cố định hoặc max-width --}}
                    {{!-- <p class="lable__search">Tìm kiếm</p> --}} {{!-- Có thể bỏ label này --}}
                    <div class="input-group "> {{!-- Dùng input-group của Bootstrap --}}
                         <input class="form-control" name="q" type="search" placeholder="Nhập tên khách hàng" value="{{searchQuery}}">
                    </div>
                     <div class="input-group ">
                         <input class="form-control" name="q1" type="search" placeholder="Nhập số điện thoại" value="{{searchPhone}}">
                    </div>
                    <button class="btn btn-primary form__sreach__btn" style="margin-top: 0; font-size: 1.4rem;">Lọc</button>

                </fsorm>
            </div>
            <div style="overflow-x: auto; white-space: nowrap;"> 
                <table class="table mt-4" style="min-width: 1400px;">
                    <thead>
                        <tr> 
                            <th scope="col">STT</th>
                            <th scope="col">Phòng</th>
                            <th scope="col">Khách hàng</th>
                            <th scope="col">Số điện thoại</th>
                            <th scope="col">Ngày đặt</th> 
                            <th scope="col">Ngày trả</th>   
                            {{!-- <th scope="col">Tiền cọc</th>
                            <th scope="col">Còn lại</th> --}}
                            <th scope="col">Tổng tiền</th>
                            <th scope="col">Trạng thái</th>                          
                            <th  colspan="3"></th>         
                        </tr>
                    </thead>
                    <tbody>
                        {{#each Bookings}}
                        <tr>                       
                            <th scope="row">{{sum @index 1}}</th>
                            <td>{{this.roomNumber}}</td>
                            <td>{{this.customer.fullName}}</td>
                            <td>{{this.customer.phone}}</td>
                            <td>{{Date this.checkInDate}}</td>  
                            <td>{{Date this.checkOutDate}}</td>
                            {{!-- <td>{{money this.depositAmount}}</td>
                            <td style="color: red;">{{money this.remainingAmount}}</td> --}}
                            <td>{{money this.totalAmount}} VNĐ</td>
                            <td>
                                {{!-- Hiển thị trạng thái với màu sắc --}}
                                {{#if (eqString this.bookingStatus 'Pending Deposit')}}
                                    <span class="badge badge-warning">{{this.bookingStatus}}</span>
                                {{else if (eqString this.bookingStatus 'Confirmed')}}
                                    <span class="badge badge-success">{{this.bookingStatus}}</span>
                                {{else if (eqString this.bookingStatus 'Checked In')}}
                                    <span class="badge badge-info">{{this.bookingStatus}}</span>
                                {{else if (eqString this.bookingStatus 'Checked Out')}}
                                    <span class="badge badge-secondary">{{this.bookingStatus}}</span>
                                {{else}}
                                    <span class="badge badge-danger">{{this.bookingStatus}}</span>
                                {{/if}}
                            </td>
                            <td style="display: flex; border-width: 0;">
                                {{#if (eqString this.bookingStatus 'Pending Deposit')}}
                                    {{!-- Nếu đang chờ cọc, hiển thị nút Xác nhận --}}
                                    <form method="POST" action="/manage/quan_li_phieuthue/crud/{{this._id}}/confirm-deposit">
                                        <button type="submit" class="btn btn-success btn-sm">Xác nhận cọc</button>
                                    </form>
                                {{else if (eqString this.bookingStatus 'Confirmed')}}
                                    {{!-- Nếu đã xác nhận, có thể cho Check-in (tính năng sau) --}}
                                    <form method="POST" action="/manage/quan_li_phieuthue/crud/{{this._id}}/check-in">
                                        <button type="submit" class="btn btn-info btn-sm">Check-in</button>
                                    </form>
                                {{else if (eqString this.bookingStatus 'Checked In')}}
                                    {{!-- Nếu đã Check-in, hiển thị nút Thanh toán (mở modal) --}}
                                    <a class="btn btn-primary btn-sm js-TraPhong"  style="font-size: 1.2rem;"
                                    data-id="{{this._id}}" {{!-- ĐẢM BẢO CÓ DÒNG NÀY --}}
                                    data-room="{{this.roomNumber}}"
                                    data-fullname="{{this.customer.fullName}}"
                                    data-phone="{{this.customer.phone}}"
                                    data-checkin="{{isoDate this.checkInDate }}"
                                    data-checkout="{{isoDate this.checkOutDate }}"
                                   data-total="{{money this.totalAmount}}" 
                                   data-deposit="{{money this.depositAmount}}" 
                                   data-remaining="{{money this.remainingAmount}}"> 
                                    Thanh toán
                                    </a>
                                {{else}}
                                    {{!-- Các trạng thái khác (Checked Out, Cancelled) có thể không cần nút --}}
                                {{/if}}

                               
                            </td>
                            <td class="btn_huy">
                                 {{#if (or (eqString this.bookingStatus 'Pending Deposit') (eqString this.bookingStatus 'Confirmed'))}}
                                    <form method="POST" action="/manage/quan_li_phieuthue/crud/{{this._id}}/cancel?_method=PUT" style="display: inline-block;" class="form-cancel-booking"> 
                                        <button type="submit" class="btn btn-danger btn-sm">Hủy</button>
                                    </form>
                                {{/if}}
                            </td>
                             <td>
                                <button class="btn btn-link p-0" type="button" data-toggle="collapse" data-target="#collapse-{{@index}}" aria-expanded="false" aria-controls="collapse-{{@index}}" style="font-size: 1.6rem;">
                                    Chi tiết
                                </button>                                                             
                            </td>
                            <td>
                                <a href="/manage/quan_li_phieuthue/crud/{{this._id}}/show_update" class="btn btn-link">Cập nhập</a>
                            </td>   
                        </tr>  
  
                        <tr class="collapse" id="collapse-{{@index}}">  
                            <td colspan="100%">
                                <div class="p-3 text-left" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                                <p><strong>Người lớn:</strong> {{this.nguoiLon}}</p>
                                <p><strong>Trẻ em:</strong> {{this.treEm}}</p>
                                 <p><strong>Dịch vụ đã sử dụng:</strong></p>
                                 <ul>
                                        {{#each this.services}}
                                        <li>{{this.service.name}} (SL: {{this.quantity}} × {{money this.price}} VNĐ)</li>
                                        {{/each}}
                                 </ul>
                                  <hr>
                                {{#if this.actualCheckInTime}}
                                    <p><strong>Check-in thực tế:</strong> {{DateTime this.actualCheckInTime}}</p>
                                {{/if}}
                                {{#if this.actualCheckOutTime}}
                                    <p><strong>Check-out thực tế:</strong> {{DateTime this.actualCheckOutTime}}</p>
                                {{/if}}
                                <hr>
                                <p><strong>Chi tiết thanh toán:</strong></p>
                                <ul>
                                    <li>Tiền phòng: {{this.soNgay}} đêm × {{money this.roomPrice}} VNĐ = {{money this.totalRoomCost}} VNĐ</li>
                                    <li>Tiền dịch vụ: {{money this.totalServiceCost}} VNĐ</li>
                                    {{#if (gt this.extraAdultSurcharge 0)}} 
                                        <li>Phụ thu thêm người: {{money this.extraAdultSurcharge}} VNĐ</li>
                                    {{/if}}
                                    <li><b>Tổng cộng: {{money this.totalAmount}} VNĐ</b></li>
                                    <li>Đã cọc: {{money this.depositAmount}} VNĐ</li>
                                    <li>Còn lại: <b style="color: red;">{{money this.remainingAmount}} VNĐ</b></li>
                                </ul>
                                </div>
                            </td>
                        </tr>
                    
                        {{else}}
                        <tr>
                            <td colspan="100%" class="text-center">
                            Bạn chưa có phiếu thuê nào.
                           
                            </td>
                        </tr>
                        {{/each}}
                   
                    </tbody>
                </table>
            </div>
            
      </div>
    </div>
  </div>  

 
 <div class="modal__booking js-modal__booking">
    <div class="modal__booking__container" style="overflow-y: auto; overflow-x: hidden">
        <div class="modal__booking__close">
            <i class="fa-solid fa-xmark"></i>
        </div>
        <div class="modal__booking__header" style="color: rgb(3, 98, 206);border-bottom: 3px solid rgb(0, 112, 244);">Hóa Đơn</div>
        
        <input type="hidden" id="bookingIdForCheckout">
        <input type="hidden" id="roomNumber">

        <div class="row" style="align-items: center; margin-left: 0;">
            <div class="modal__booking__title" id="modalRoom" style="color:rgb(0, 112, 244) ;"></div>
                <p style="font-size: 1.4rem; color: #555; margin-bottom: 0;">
                    <em>Giờ trả phòng hiện tại: <strong id="modalActualCheckoutTime">--:-- --/--/----</strong></em>
                </p>
        </div>
        <div class="row modal__booking__contet">
            <div class="col-6">
                <div class="modal__booking__body">
                    <label class="modal__booking__label" style="color:rgb(0, 112, 244) ;">Mã hóa đơn</label>
                    <input type="text" id="maHoaDon" class="modal__booking__input" readonly>
                </div>
                <div class="modal__booking__body">
                    <label class="modal__booking__label" style="color:rgb(0, 112, 244) ;">Họ tên</label>
                    <input type="text" id="fullName" class="modal__booking__input" readonly>
                </div>
                <div class="modal__booking__body">
                    <label class="modal__booking__label" style="color:rgb(0, 112, 244) ;">Nhận phòng</label>
                    <input type="date" id="checkInDate" class="modal__booking__input" readonly>
                </div>
            </div>
            <div class="col-6">
                <div class="modal__booking__body">
                    <label class="modal__booking__label" style="color:rgb(0, 112, 244) ;">Số điện thoại</label>
                    <input type="text" id="phone" class="modal__booking__input" readonly>
                </div>
                <div class="modal__booking__body">
                    <label class="modal__booking__label" style="color:rgb(0, 112, 244) ;">Trả phòng</label>
                    <input type="date" id="checkOutDate" class="modal__booking__input" readonly>
                </div>
            </div>
        </div>
        
        <div class="modal__booking__title" style="margin-top: 20px; color: red;" id="modalTotalAmount"></div>
        <div class="modal__booking__title" style="margin-top: 10px; color: red;" id="modalDepositAmount"></div>
        <div class="modal__booking__title" style="margin-top: 10px; color: red;" id="modalLateFee">Phí trả muộn: ...</div>
        <div class="modal__booking__title" style="margin-top: 10px; color: rgb(250, 0, 0); font-weight: bold;" id="modalRemainingAmount"></div>
        
        <div class="modal__booking__frame__btn" style="background-color: rgb(3, 98, 206);">
            <button type="button" class="btn modal__booking__btn" style="background-color:rgb(34, 136, 253) ;">Lưu hóa đơn</button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.querySelector('.js-modal__booking');
  const modalClose = document.querySelector('.modal__booking__close');
  const maHoaDonInput = document.getElementById('maHoaDon'); 

  // Đóng modal
  modalClose.addEventListener('click', () => {
    modal.classList.remove('open');
    document.body.classList.remove('no-scroll');
  });

  // Mở modal và gán dữ liệu
  document.querySelectorAll('.js-TraPhong').forEach(btn => {
     btn.addEventListener('click', async function () {
      modal.classList.add('open');
      document.body.classList.add('no-scroll');

    try {
        maHoaDonInput.value = 'Đang tải...';
        maHoaDonInput.disabled = true;

        const response = await fetch('/manage/quan_li_hoadon/crud/get-next-id');
        if (!response.ok) {
            throw new Error('Không thể lấy mã hóa đơn');
        }
        const data = await response.json();

        maHoaDonInput.value = data.nextBillId;
      } catch (error) {
          console.error(error);
          maHoaDonInput.value = 'Lỗi!'; // Báo lỗi nếu không lấy được
      }
      // Lấy dữ liệu từ data-*
      const dataset = this.dataset;

        document.getElementById('modalRoom').innerText = 'Phòng ' + dataset.room;
        document.getElementById('fullName').value = dataset.fullname;
        document.getElementById('phone').value = dataset.phone;
        document.getElementById('checkInDate').value = dataset.checkin;
        document.getElementById('checkOutDate').value = dataset.checkout;
        document.getElementById('bookingIdForCheckout').value = dataset.id;

        // **THAY ĐỔI QUAN TRỌNG: Điền thông tin tài chính chi tiết**
        document.getElementById('modalTotalAmount').innerHTML = `<span>Tổng tiền:</span> ${dataset.total} VNĐ`;
        document.getElementById('modalDepositAmount').innerHTML = `<span>Đã cọc:</span> ${dataset.deposit} VNĐ`;
        document.getElementById('modalRemainingAmount').innerHTML = `<span>Cần thanh toán:</span> ${dataset.remaining} VNĐ`;

        const now = new Date();
        const formattedCheckoutTime =
            `${now.getHours().toString().padStart(2, '0')}:` + // Giờ
            `${now.getMinutes().toString().padStart(2, '0')} ` + // Phút
            `${now.getDate().toString().padStart(2, '0')}/` +   // Ngày
            `${(now.getMonth() + 1).toString().padStart(2, '0')}/` + // Tháng
            `${now.getFullYear()}`;                             // Năm
        document.getElementById('modalActualCheckoutTime').textContent = formattedCheckoutTime;
    });
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btnLuu = document.querySelector('.modal__booking__btn');

    btnLuu.addEventListener('click', () => {
        // 1. Dữ liệu gửi đi giờ rất đơn giản và an toàn
        const billData = {
            idBill: document.getElementById('maHoaDon').value.trim(),
            bookingId: document.getElementById('bookingIdForCheckout').value
        };
        
        // Kiểm tra nếu chưa có bookingId thì không làm gì cả
        if (!billData.bookingId) {
            alert('Lỗi: Không tìm thấy thông tin phiếu thuê.');
            return;
        }

        // 2. Gọi API Lưu hóa đơn (bước đầu tiên trong chuỗi xử lý của bạn)
        fetch('/manage/quan_li_hoadon/crud/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billData)
        })
        .then(res => {
            if (!res.ok) throw new Error('Bước 1: Lưu hóa đơn thất bại');
            return res.json();
        })
        .then(billRes => {
            if (billRes.message === 'success') {
                // 3. LƯU HÓA ĐƠN THÀNH CÔNG -> Gọi API Checkout Booking
                return fetch(`/manage/quan_li_phieuthue/crud/${billData.bookingId}/checkout`, {
                    method: 'POST'
                })
                .then(checkoutRes => {
                    if (!checkoutRes.ok) throw new Error('Bước 2: Cập nhật trạng thái booking thất bại');
                    return checkoutRes.json();
                });
            } else {
                throw new Error(billRes.message || 'Lưu hóa đơn thất bại!');
            }
        })
        .then(checkoutBookingRes => {
            if (checkoutBookingRes.message === 'success') {
                // 4. MỌI THỨ THÀNH CÔNG -> Thông báo và tải lại trang
                alert('Thanh toán và trả phòng thành công!');
                window.location.reload();
            } else {
                throw new Error(checkoutBookingRes.message || 'Cập nhật trạng thái booking thất bại!');
            }
        })
        .catch(err => {
            // 5. Bắt tất cả lỗi từ chuỗi API và hiển thị
            console.error('Lỗi trong quá trình thanh toán:', err);
            alert('Có lỗi xảy ra: ' + err.message);
        });
    });

    const cancelForms = document.querySelectorAll('.form-cancel-booking');
    cancelForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            // Ngăn form submit ngay lập tức
            event.preventDefault();

            // Lấy thông tin để hiển thị xác nhận (tùy chọn)
            const row = form.closest('tr'); // Lấy hàng chứa form
            const roomNumber = row.querySelector('td:nth-child(3)').textContent; // Lấy số phòng từ cột thứ 3
            const customerName = row.querySelector('td:nth-child(4)').textContent; // Lấy tên khách từ cột thứ 4

            // Hiển thị hộp thoại xác nhận
            const confirmed = confirm(`Bạn có chắc chắn muốn hủy phiếu thuê phòng ${roomNumber} của khách ${customerName} không?`);

            // Nếu người dùng xác nhận => Submit form
            if (confirmed) {
                form.submit(); // Gửi request POST với _method=PUT
            }
            // Nếu không xác nhận, không làm gì cả
        });
    });
});
</script>

{{!-- <script>
    document.addEventListener('DOMContentLoaded', function(){
        var courseId;
        var deleteForm = document.forms['delete-course-form']
        var btnDeleteCourse = document.getElementById('btn-id-delete')
        var submitForm = document.forms['submit_request_delete']
        var checkBoxAll = $('#checkbox-all')
        var courseItemCheckbox = $('input[name="courseIds[]"]')
        var bthExec = $('.btn-exec')


        $('#exampleModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) 
            courseId = button.data('id') 
        })

        btnDeleteCourse.onclick = function(){
            deleteForm.action = '/manage/quan_li_dichvu/crud/' + courseId + '/delete?_method=DELETE';
            deleteForm.submit()
        }
        
        //check box all change
        checkBoxAll.change(function(){
          var isChecked = $(this).prop('checked');

          if(isChecked){
            courseItemCheckbox.prop('checked', true)
          }else{
            courseItemCheckbox.prop('checked', false)
          }
          renderCheckAllSubmitBtn()
        })

        //Course item checkbox
        courseItemCheckbox.change(function(){
          var isCheckedAll = courseItemCheckbox.length === $('input[name="courseIds[]"]:checked').length
          if(isCheckedAll){
            checkBoxAll.prop('checked', true)
          }else{
             checkBoxAll.prop('checked', false)
          }
          renderCheckAllSubmitBtn()
        })

        //check btn submit click

        bthExec.on('submit', function(e){
          var isSubmitable = !$(this).hasClass('disabled')
          if(!isSubmitable){
             e.preventDefault();
          }
        })

        function renderCheckAllSubmitBtn() {
          var checkedCount = $('input[name="courseIds[]"]:checked').length;
        
         if(checkedCount > 0){
              bthExec.removeClass('disabled')
          }else{
              bthExec.addClass('disabled')
          }
          
        }
    })
   
</script> --}}



